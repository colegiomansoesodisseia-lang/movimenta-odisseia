<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Inscri√ß√µes Movimenta Odisseia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Evitar cache em celular / navegador -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --azul: #0056b3;
            --azul-claro: #e3f1ff;
            --cinza: #f5f5f5;
            --borda: #d0d7e2;
            --vermelho: #d9534f;
            --verde: #28a745;
            --texto: #222;
        }
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            margin: 0;
            background: #f0f4fb;
            color: var(--texto);
        }

        /* Overlay de e-mail */
        #emailOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #emailOverlayCard {
            background: #ffffff;
            padding: 20px 18px;
            border-radius: 12px;
            max-width: 380px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        #emailOverlayCard h2 {
            margin: 0 0 6px;
            font-size: 1.1rem;
            color: var(--azul);
        }
        #emailOverlayCard p {
            margin: 4px 0 10px;
            font-size: 0.9rem;
            color: #444;
        }
        #emailOverlayCard input {
            width: 100%;
            padding: 8px 9px;
            border-radius: 8px;
            border: 1px solid var(--borda);
            background: #fafbff;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        #emailOverlayCard .btn {
            width: 100%;
            justify-content: center;
        }
        #msgEmailOverlay {
            font-size: 0.8rem;
            color: var(--vermelho);
            margin-bottom: 6px;
            min-height: 14px;
        }

        header {
            background: linear-gradient(90deg, var(--azul) 0%, #007bff 100%);
            color: #fff;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        header h1 {
            margin: 0;
            font-size: 1.2rem;
        }
        header span.subtitulo {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button,
        select,
        input,
        textarea {
            font-size: 0.95rem;
        }
        .btn {
            border: none;
            border-radius: 999px;
            padding: 8px 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
        }
        .btn-primaria {
            background: #ffffff;
            color: var(--azul);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .btn-primaria:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn-admin {
            background: rgba(255,255,255,0.15);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .btn-admin:hover {
            background: rgba(255,255,255,0.3);
        }

        main {
            max-width: 1100px;
            margin: 20px auto 30px;
            padding: 0 12px 20px;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid var(--borda);
            padding: 18px 16px 20px;
            margin-bottom: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
        }
        .card h2 {
            margin: 0 0 10px;
            font-size: 1.1rem;
            color: var(--azul);
        }
        .card small {
            color: #666;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        label {
            font-size: 0.9rem;
            font-weight: 500;
            display: block;
            margin-bottom: 3px;
        }
        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 8px 9px;
            border-radius: 8px;
            border: 1px solid var(--borda);
            background: #fafbff;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        .modalidades-lista {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 6px;
        }
        .modalidade-item {
            border-radius: 10px;
            border: 1px solid var(--borda);
            padding: 6px 8px;
            background: var(--azul-claro);
            display: flex;
            align-items: flex-start;
            gap: 6px;
            font-size: 0.88rem;
        }
        .modalidade-item input {
            margin-top: 3px;
        }
        .modalidade-label {
            font-weight: 600;
            display: block;
        }
        .modalidade-vagas {
            font-size: 0.78rem;
            color: #333;
        }
        .modalidade-lotado {
            color: var(--vermelho);
            font-weight: 600;
        }
        .alerta {
            margin-top: 4px;
            font-size: 0.8rem;
            color: #555;
        }
        .alerta strong {
            color: var(--vermelho);
        }
        .msg-erro {
            background: #ffe5e5;
            color: #b30000;
            border-radius: 8px;
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 0.86rem;
        }
        .msg-sucesso {
            background: #e5ffe9;
            color: #0c7a2a;
            border-radius: 8px;
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 0.86rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.86rem;
        }
        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid #e1e4eb;
            text-align: left;
        }
        th {
            background: #f2f5ff;
            font-weight: 600;
        }
        tr:hover td {
            background: #f9fbff;
        }
        .filtros {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }
        .filtros > div {
            min-width: 160px;
        }

        .pill-info {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            background: var(--azul-claro);
            font-size: 0.75rem;
            margin-top: 4px;
        }

        /* √Årea admin */
        #adminSection {
            display: none;
        }
        .admin-tag {
            font-size: 0.76rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #555;
        }
        .admin-actions {
            margin-top: 14px;
            padding: 10px;
            border-radius: 8px;
            background: #f9fbff;
            border: 1px dashed #c5cde0;
        }
        .admin-actions h3 {
            margin-top: 0;
            font-size: 0.95rem;
            color: var(--azul);
        }

        /* Painel de inscritos come√ßa escondido */
        #secInscritos {
            display: none;
        }

        /* Campo de busca admin */
        #adminSearch {
            width: 100%;
            max-width: 300px;
            margin-top: 8px;
        }

        /* JOGOS - nova se√ß√£o de visualiza√ß√£o */
        #secJogos {
            display: none;
        }
        .jogo-tabela-wrapper {
            margin-top: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--borda);
            background: #f9fbff;
        }
        .jogo-tabela-wrapper h4 {
            margin: 0 0 4px;
            font-size: 0.95rem;
            color: var(--azul);
        }
    </style>
</head>
<body>

<!-- OVERLAY DE E-MAIL -->
<div id="emailOverlay">
    <div id="emailOverlayCard">
        <h2>Antes de continuar...</h2>
        <p>Informe seu <strong>e-mail</strong> para registrar sua inscri√ß√£o no Movimenta Odisseia.</p>
        <div id="msgEmailOverlay"></div>
        <input type="text" id="emailAluno" placeholder="Digite seu e-mail" />
        <button id="btnEntrarEmail" class="btn btn-primaria">Entrar no sistema</button>
    </div>
</div>

<header>
    <div>
        <h1>Inscri√ß√µes Movimenta Odisseia</h1>
        <span class="subtitulo">Inscri√ß√µes para o Movimenta Odisseia</span>
    </div>
    <div class="header-right">
        <button id="btnToggleInscritos" class="btn btn-primaria">
            üëÄ Ver inscritos
        </button>
        <!-- JOGOS: novo bot√£o no topo -->
        <button id="btnVerJogos" class="btn btn-primaria">
            üèÜ Ver jogos
        </button>
        <button id="btnAdminArea" class="btn btn-admin">
            üîê √Årea Administrativa
        </button>
    </div>
</header>

<main>
    <!-- FORMUL√ÅRIO DE INSCRI√á√ÉO -->
    <section class="card" id="secInscricao">
        <h2>Formul√°rio de inscri√ß√£o</h2>
        <small>Preencha seus dados e escolha at√© <strong>2 modalidades</strong>.</small>

        <div id="msgForm"></div>

        <form id="formInscricao">
            <div class="grid-2">
                <div>
                    <label for="nome">Nome completo</label>
                    <input type="text" id="nome" placeholder="Ex: Victor Hugo Silva Miranda" required />
                </div>
                <div>
                    <label for="sexo">Sexo</label>
                    <select id="sexo" required>
                        <option value="">Selecione...</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Masculino">Masculino</option>
                    </select>
                </div>
            </div>

            <div class="grid-2" style="margin-top:10px;">
                <div>
                    <label for="turno">Turno</label>
                    <select id="turno" required>
                        <option value="">Selecione o turno...</option>
                        <option value="Matutino">Matutino</option>
                        <option value="Vespertino">Vespertino</option>
                        <option value="Noturno">Noturno</option>
                    </select>
                </div>
                <div>
                    <label for="turma">Turma</label>
                    <select id="turma" required>
                        <option value="">Selecione o turno primeiro...</option>
                    </select>
                </div>
            </div>

            <div class="grid-2" style="margin-top:10px;">
                <div>
                    <label for="camisaNumero">N√∫mero da camisa (opcional)</label>
                    <input type="text" id="camisaNumero" placeholder="Ex: 10, 07, 23..." />
                </div>
                <div>
                    <label for="observacoes">Observa√ß√µes (posi√ß√£o em quadra, restri√ß√µes, etc.)</label>
                    <textarea id="observacoes" placeholder="Ex: Goleiro no futsal, prefere queimada mista..."></textarea>
                </div>
            </div>

            <div style="margin-top:14px;">
                <label>Modalidades (m√°ximo 2 por aluno)</label>
                <p class="alerta">
                    ‚úÖ FUTSAL: 8 pessoas por turma.<br>
                    ‚úÖ DOMIN√ì / FUTMESA / XADREZ / T√äNIS DE MESA / VOLEI: 2, 2, 2, 2 e 6 pessoas por turma (conforme regra).<br>
                    ‚úÖ QUEIMADA MISTA: at√© 5 meninas e 5 meninos por turma.
                </p>
                <div class="modalidades-lista" id="modalidadesContainer">
                    <!-- preenchido via JS -->
                </div>
            </div>

            <div style="margin-top:14px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
                <span class="pill-info">As inscri√ß√µes s√£o atualizadas em tempo real. Use "Ver inscritos" para ver o geral.</span>
                <button type="submit" class="btn btn-primaria">
                    ‚úÖ Enviar inscri√ß√£o
                </button>
            </div>
        </form>
    </section>

    <!-- LISTA P√öBLICA DE INSCRITOS (VISUALIZA√á√ÉO ALUNO) -->
    <section class="card" id="secInscritos">
        <h2>Painel de inscritos (visualiza√ß√£o dos alunos)</h2>
        <small>Aqui voc√™ pode ver quem j√° est√° inscrito, por turma e modalidade. S√≥ aparece <strong>nome completo</strong> e <strong>turma</strong>.</small>

        <div class="filtros">
            <div>
                <label for="filtroModalidade">Filtrar por modalidade</label>
                <select id="filtroModalidade">
                    <option value="TODAS">Todas</option>
                    <!-- modalidades via JS -->
                </select>
            </div>
            <div>
                <label for="filtroTurma">Filtrar por turma</label>
                <select id="filtroTurma">
                    <option value="TODAS">Todas</option>
                    <!-- turmas via JS -->
                </select>
            </div>
        </div>

        <table id="tabelaPublica">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Turma</th>
                </tr>
            </thead>
            <tbody>
                <!-- linhas via JS -->
            </tbody>
        </table>
    </section>

    <!-- JOGOS (VISUALIZA√á√ÉO ALUNO) -->
    <section class="card" id="secJogos">
        <h2>Jogos por turno</h2>
        <small>Selecione a s√©rie e, se quiser, filtre por data para ver as partidas cadastradas.</small>

        <div class="filtros" style="margin-top:8px;">
            <div>
                <label for="filtroSerieJogo">Selecionar s√©rie</label>
                <select id="filtroSerieJogo">
                    <option value="">Selecione a s√©rie...</option>
                    <option value="6">6¬∫ ano</option>
                    <option value="7">7¬∫ ano</option>
                    <option value="8">8¬∫ ano</option>
                    <option value="9">9¬∫ ano</option>
                    <option value="1">1¬∫ ano</option>
                    <option value="2">2¬∫ ano</option>
                    <option value="3">3¬∫ ano</option>
                </select>
            </div>
            <div>
                <label for="filtroDataJogo">Filtrar por data (opcional)</label>
                <input type="date" id="filtroDataJogo" />
            </div>
        </div>

        <div id="listaJogosContainer" style="margin-top:10px;">
            <!-- tabelinhas de jogos via JS -->
        </div>
    </section>

    <!-- √ÅREA ADMINISTRATIVA (SOMENTE COM SENHA) -->
    <section class="card" id="adminSection">
        <h2>√Årea Administrativa</h2>
        <div class="admin-tag">Apenas para coordena√ß√£o / organiza√ß√£o do Movimenta Odisseia</div>
        <button id="btnFecharAdmin" class="btn btn-primaria" style="margin-top:8px; margin-bottom:6px;">
            ‚¨Ö Fechar √°rea administrativa
        </button>
        <small>Aqui aparecem todas as inscri√ß√µes com detalhes e relat√≥rios para chaveamento.</small>

        <!-- BUSCA DE ALUNO -->
        <div class="admin-actions">
            <h3>Buscar aluno</h3>
            <p style="font-size:0.84rem; margin:4px 0 8px;">
                Digite o nome (ou parte do nome) para localizar na tabela de inscri√ß√µes.
            </p>
            <input type="text" id="adminSearch" placeholder="Buscar por nome..." />
        </div>

        <!-- BLOCO DE EXCE√á√ïES DE NOME -->
        <div class="admin-actions">
            <h3>Autorizar nome com 2 nomes</h3>
            <p style="font-size:0.84rem; margin:4px 0 8px;">
                Nomes com <strong>3 ou mais palavras</strong> entram normalmente.<br>
                Se um aluno tiver apenas <strong>2 nomes</strong> e voc√™ quiser liberar, digite o nome exatamente como ele ser√° escrito no formul√°rio e clique em <em>"Autorizar"</em>.
            </p>
            <div style="display:flex; flex-wrap:wrap; gap:6px;">
                <input type="text" id="nomeExcecao" placeholder="Nome a ser autorizado (igual o aluno vai digitar)" style="flex:1; min-width:200px;" />
                <button id="btnAdicionarExcecao" class="btn btn-primaria">Autorizar nome</button>
            </div>
            <ul id="listaExcecoes" style="margin-top:8px; padding-left:18px; font-size:0.85rem;"></ul>
        </div>

        <!-- BLOCO DE CANCELAMENTO DE INSCRI√á√ÉO -->
        <div class="admin-actions">
            <h3>Cancelar inscri√ß√£o</h3>
            <p style="font-size:0.84rem; margin:4px 0 8px;">
                Selecione um aluno para cancelar a inscri√ß√£o. Isso remove o registro do banco e libera as vagas das modalidades daquela turma.
            </p>
            <div style="display:flex; flex-wrap:wrap; gap:6px;">
                <select id="selectCancelar" style="flex:1; min-width:220px;">
                    <option value="">Selecione um inscrito...</option>
                </select>
                <button id="btnCancelarInscricao" class="btn btn-primaria">Cancelar inscri√ß√£o selecionada</button>
            </div>
        </div>

        <!-- RELAT√ìRIO POR MODALIDADE / TURMA (COM BOT√ÉO) -->
        <div class="admin-actions">
            <h3>Relat√≥rio por modalidade / turma</h3>
            <p style="font-size:0.84rem; margin:4px 0 8px;">
                Selecione a turma e a modalidade, clique em <strong>Relat√≥rio</strong> e depois em <strong>Imprimir relat√≥rio</strong> para usar no chaveamento.
            </p>
            <div class="filtros">
                <div>
                    <label for="relTurma">Turma</label>
                    <select id="relTurma">
                        <option value="">Selecione...</option>
                        <!-- turmas via JS -->
                    </select>
                </div>
                <div>
                    <label for="relModalidade">Modalidade</label>
                    <select id="relModalidade">
                        <option value="">Selecione...</option>
                        <!-- modalidades via JS -->
                    </select>
                </div>
                <div style="align-self:flex-end;">
                    <button id="btnGerarRelatorio" class="btn btn-primaria">üìÑ Gerar relat√≥rio</button>
                </div>
            </div>

            <table id="tabelaRelatorio">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Sexo</th>
                        <th>Turma</th>
                        <th>Turno</th>
                        <th>N¬∫ camisa</th>
                        <th>Modalidades</th>
                        <th>Observa√ß√µes</th>
                        <th>Data/Hora</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- preenchido pelo bot√£o -->
                </tbody>
            </table>

            <button id="btnImprimirRelatorio" class="btn btn-primaria" style="margin-top:8px;">
                üñ®Ô∏è Imprimir relat√≥rio
            </button>
        </div>

        <div style="margin-top:14px;">
            <table id="tabelaAdmin">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Sexo</th>
                        <th>Turma</th>
                        <th>Turno</th>
                        <th>N¬∫ camisa</th>
                        <th>Modalidades</th>
                        <th>Observa√ß√µes</th>
                        <th>Data/Hora</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- via JS -->
                </tbody>
            </table>
        </div>

        <!-- JOGOS: se√ß√£o "Montar jogos" na √°rea administrativa -->
        <div class="admin-actions">
            <h3>Montar jogos</h3>
            <p style="font-size:0.84rem; margin:4px 0 8px;">
                Cadastre as partidas informando turno, turmas, data, hor√°rio e local. Os jogos aparecer√£o automaticamente no bot√£o <strong>Ver jogos</strong>, filtrados pelo turno.
            </p>
            <div class="grid-2">
                <div>
                    <label for="jogoTurno">Selecionar Turno</label>
                    <select id="jogoTurno">
                        <option value="">Selecione o turno...</option>
                        <option value="Matutino">Matutino</option>
                        <option value="Vespertino">Vespertino</option>
                        <option value="Noturno">Noturno</option>
                    </select>
                </div>
                <div>
                    <label for="jogoData">Selecionar Data do jogo</label>
                    <input type="date" id="jogoData" />
                </div>
            </div>

            <div class="grid-2" style="margin-top:10px;">
                <div>
                    <label for="jogoTurma1">Selecionar Turma 1</label>
                    <select id="jogoTurma1">
                        <option value="">Selecione o turno primeiro...</option>
                    </select>
                </div>
                <div>
                    <label for="jogoTurma2">Selecionar Turma 2</label>
                    <select id="jogoTurma2">
                        <option value="">Selecione o turno primeiro...</option>
                    </select>
                </div>
            </div>

            <div class="grid-2" style="margin-top:10px;">
                <div>
                    <label for="jogoHorario">Selecionar Hor√°rio</label>
                    <input type="time" id="jogoHorario" />
                </div>
                <div>
                    <label for="jogoLocal">Selecionar Local</label>
                    <input type="text" id="jogoLocal" placeholder="Ex: Quadra principal" />
                </div>
            </div>

            <button id="btnCadastrarJogo" class="btn btn-primaria" style="margin-top:10px;">
                Cadastrar jogo
            </button>

            <!-- EXCLUIR JOGO -->
            <div style="margin-top:12px;">
                <h4 style="margin:0 0 6px; font-size:0.9rem; color:var(--azul);">Excluir jogo cadastrado</h4>
                <p style="font-size:0.8rem; margin:0 0 6px;">
                    Selecione um jogo da lista e clique em <strong>Excluir jogo selecionado</strong> para remov√™-lo.
                </p>
                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                    <select id="selectExcluirJogo" style="flex:1; min-width:220px;">
                        <option value="">Selecione um jogo...</option>
                    </select>
                    <button id="btnExcluirJogo" class="btn btn-primaria">Excluir jogo selecionado</button>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
'use strict';

/* ============= 1) FIREBASE ============= */

const firebaseConfig = {
  apiKey: "AIzaSyAxB-FrZNQ7DE-e_YJOvNkkwAaCToH9nd8",
  authDomain: "inscricoes-movimenta.firebaseapp.com",
  projectId: "inscricoes-movimenta",
  storageBucket: "inscricoes-movimenta.firebasestorage.app",
  messagingSenderId: "383820865072",
  appId: "1:383820865072:web:c8602b5c2cbcd5884057f5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============= 2) DADOS FIXOS ============= */

const MODALIDADES = [
    "FUTSAL",
    "QUEIMADA MISTA",
    "DOMIN√ì",
    "FUTMESA",
    "T√äNIS DE MESA",
    "XADREZ",
    "VOLEI"
];

const TURMAS = [
    "6¬∫A","6¬∫B","6¬∫C","6¬∫D","6¬∫E","6¬∫F","6¬∫G",
    "7¬∫A","7¬∫B","7¬∫C","7¬∫D","7¬∫E","7¬∫F",
    "8¬∫A","8¬∫B","8¬∫C","8¬∫D","8¬∫E","8¬∫F",
    "9¬∫A","9¬∫B","9¬∫C","9¬∫D","9¬∫E",
    "1¬∫A","1¬∫B","1¬∫C","1¬∫D","1¬∫E","1¬∫F",
    "2¬∫A","2¬∫B","2¬∫C",
    "3¬∫A","3¬∫B","3¬∫C"
];

const TURMAS_MATUTINO = [
    "7¬∫A","7¬∫B","7¬∫C","7¬∫D","7¬∫E","7¬∫F",
    "8¬∫F",
    "9¬∫A","9¬∫B","9¬∫C","9¬∫D","9¬∫E"
];

const TURMAS_VESPERTINO = [
    "6¬∫A","6¬∫B","6¬∫C","6¬∫D","6¬∫E","6¬∫F","6¬∫G",
    "8¬∫A","8¬∫B","8¬∫C","8¬∫D","8¬∫E"
];

const TURMAS_NOTURNO = [
    "1¬∫A","1¬∫B","1¬∫C","1¬∫D","1¬∫E","1¬∫F",
    "2¬∫A","2¬∫B","2¬∫C",
    "3¬∫A","3¬∫B","3¬∫C"
];

const LIMITE_MODALIDADE_TURMA = {
    "FUTSAL": 8,
    "DOMIN√ì": 2,
    "FUTMESA": 2,
    "T√äNIS DE MESA": 2,
    "XADREZ": 2,
    "VOLEI": 6
};

const LIMITE_QUEIMADA_TOTAL = 10; // 5 meninas + 5 meninos
const LIMITE_QUEIMADA_POR_SEXO = 5;

const LIMITE_MODALIDADES_POR_ALUNO = 2;
const ADMIN_PASSWORD = "52090949";

/* ============= 2.1) DATA DE EXPIRA√á√ÉO DAS INSCRI√á√ïES ============= */
/* Inscri√ß√µes v√°lidas at√© 08/12/2025 (inclusive).
   A partir de 09/12/2025 00:00 o formul√°rio √© bloqueado. */
const DATA_EXPIRACAO = new Date(2025, 11, 9, 0, 0, 0); // 09/12/2025 00:00

/* ============= 3) ESTADO ============= */

let countsPorTurmaModalidade = {};
let countsQueimadaGenero = {};
let todasInscricoes = [];
let isAdmin = false;
let adminAberto = false;
let mostrandoInscritos = false;
let nomesExcecao = [];
let emailAtual = null;
let inscricoesEncerradas = false;

/* JOGOS - estado */
let todosJogos = [];
let mostrandoJogos = false;

/* ============= 4) AUXILIARES ============= */

function normalizarNome(str) {
    if (!str) return "";
    return str
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ");
}

function mostrarMensagemForm(texto, sucesso) {
    const msgBox = document.getElementById("msgForm");
    if (!msgBox) return;
    msgBox.innerHTML = "";
    const div = document.createElement("div");
    div.className = sucesso ? "msg-sucesso" : "msg-erro";
    div.textContent = texto;
    msgBox.appendChild(div);
}

function getTurmasPorTurno(turno) {
    if (turno === "Matutino") return TURMAS_MATUTINO;
    if (turno === "Vespertino") return TURMAS_VESPERTINO;
    if (turno === "Noturno") return TURMAS_NOTURNO;
    return [];
}

function validarEmail(email) {
    if (!email) return false;
    return email.includes("@") && email.includes(".");
}

/* JOGOS - formatar data para dd/mm/aaaa */
function formatarDataBR(isoStr) {
    if (!isoStr) return "-";
    const partes = isoStr.split("-");
    if (partes.length !== 3) return isoStr;
    const [ano, mes, dia] = partes;
    return dia + "/" + mes + "/" + ano;
}

/* JOGOS - pegar "s√©rie" pela turma (primeiro d√≠gito) */
function getSerieDigitFromTurma(turma) {
    if (!turma || typeof turma !== "string") return "";
    // Ex: "6¬∫A" -> "6", "1¬∫C" -> "1"
    return turma.charAt(0);
}

/* Verifica se as inscri√ß√µes j√° expiraram e, se sim, bloqueia o formul√°rio */
function verificarExpiracao() {
    const agora = new Date();
    inscricoesEncerradas = agora >= DATA_EXPIRACAO;
    if (inscricoesEncerradas) {
        const form = document.getElementById("formInscricao");
        if (form) {
            const campos = form.querySelectorAll("input, select, textarea, button[type='submit']");
            campos.forEach(el => el.disabled = true);
        }
        mostrarMensagemForm("As inscri√ß√µes foram encerradas. Prazo final: 08/12/2025.", false);
    }
}

/* ============= 5) INICIALIZA√á√ÉO ============= */

function initInterclasse() {
    const selectTurma = document.getElementById("turma");
    const selectTurno = document.getElementById("turno");
    const selectSexo = document.getElementById("sexo");
    const filtroTurma = document.getElementById("filtroTurma");
    const filtroModalidade = document.getElementById("filtroModalidade");
    const modalidadesContainer = document.getElementById("modalidadesContainer");
    const relTurma = document.getElementById("relTurma");
    const relModalidade = document.getElementById("relModalidade");

    // JOGOS - elementos
    const btnVerJogos = document.getElementById("btnVerJogos");
    const filtroSerieJogo = document.getElementById("filtroSerieJogo");
    const filtroDataJogo = document.getElementById("filtroDataJogo");
    const jogoTurno = document.getElementById("jogoTurno");
    const jogoTurma1 = document.getElementById("jogoTurma1");
    const jogoTurma2 = document.getElementById("jogoTurma2");
    const btnCadastrarJogo = document.getElementById("btnCadastrarJogo");
    const btnExcluirJogo = document.getElementById("btnExcluirJogo");

    if (!selectTurma || !selectTurno || !filtroTurma || !filtroModalidade || !modalidadesContainer) {
        console.error("Erro ao carregar elementos principais. Verifique o HTML.");
        return;
    }

    // Overlay de e-mail (sempre pede, tanto no PC quanto no celular)
    const overlay = document.getElementById("emailOverlay");
    const emailInput = document.getElementById("emailAluno");
    const btnEntrarEmail = document.getElementById("btnEntrarEmail");
    const msgEmailOverlay = document.getElementById("msgEmailOverlay");

    function liberarComEmail() {
        const valor = (emailInput.value || "").trim();
        if (!validarEmail(valor)) {
            msgEmailOverlay.textContent = "Digite um e-mail v√°lido.";
            return;
        }
        emailAtual = valor;
        overlay.style.display = "none";
    }

    overlay.style.display = "flex";
    btnEntrarEmail.addEventListener("click", liberarComEmail);
    emailInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            liberarComEmail();
        }
    });

    // Verifica expira√ß√£o logo na inicializa√ß√£o
    verificarExpiracao();

    selectTurma.disabled = true;

    TURMAS.forEach(function(t) {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        filtroTurma.appendChild(opt);
    });

    MODALIDADES.forEach(function(m) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        filtroModalidade.appendChild(opt);
    });

    if (relTurma) {
        TURMAS.forEach(function(t) {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            relTurma.appendChild(opt);
        });
    }
    if (relModalidade) {
        MODALIDADES.forEach(function(m) {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            relModalidade.appendChild(opt);
        });
    }

    MODALIDADES.forEach(function(mod) {
        const div = document.createElement("div");
        div.className = "modalidade-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = mod;
        checkbox.classList.add("chkModalidade");

        const infoDiv = document.createElement("div");
        const lbl = document.createElement("span");
        lbl.className = "modalidade-label";
        lbl.textContent = mod;

        const vagas = document.createElement("span");
        vagas.className = "modalidade-vagas";
        vagas.dataset.mod = mod;
        vagas.textContent = "Selecione turno e turma para ver as vagas.";

        infoDiv.appendChild(lbl);
        infoDiv.appendChild(vagas);

        div.appendChild(checkbox);
        div.appendChild(infoDiv);
        modalidadesContainer.appendChild(div);
    });

    modalidadesContainer.addEventListener("change", function(e) {
        if (e.target.classList.contains("chkModalidade")) {
            const selecionados = document.querySelectorAll(".chkModalidade:checked");
            if (selecionados.length > LIMITE_MODALIDADES_POR_ALUNO) {
                e.target.checked = false;
                alert("Voc√™ s√≥ pode escolher at√© " + LIMITE_MODALIDADES_POR_ALUNO + " modalidades.");
            }
        }
    });

    selectTurno.addEventListener("change", function() {
        const turno = selectTurno.value;
        const turmasTurno = getTurmasPorTurno(turno);
        selectTurma.innerHTML = "";
        const optDefault = document.createElement("option");
        optDefault.value = "";
        optDefault.textContent = turno ? "Selecione a turma..." : "Selecione o turno primeiro...";
        selectTurma.appendChild(optDefault);

        if (!turno) {
            selectTurma.disabled = true;
        } else {
            turmasTurno.forEach(function(t) {
                const opt = document.createElement("option");
                opt.value = t;
                opt.textContent = t;
                selectTurma.appendChild(opt);
            });
            selectTurma.disabled = false;
        }
        atualizarDisponibilidadeModalidades();
    });

    selectTurma.addEventListener("change", atualizarDisponibilidadeModalidades);
    selectSexo.addEventListener("change", atualizarDisponibilidadeModalidades);

    filtroTurma.addEventListener("change", renderizarTabelaPublica);
    filtroModalidade.addEventListener("change", renderizarTabelaPublica);

    document.getElementById("btnToggleInscritos").addEventListener("click", alternarPainelInscritos);

    document.getElementById("btnAdminArea").addEventListener("click", function() {
        if (!isAdmin) {
            const senha = prompt("Digite a senha da √°rea administrativa:");
            if (senha === ADMIN_PASSWORD) {
                isAdmin = true;
                abrirAdmin();
            } else if (senha !== null) {
                alert("Senha incorreta.");
            }
        } else {
            abrirAdmin();
        }
    });

    document.getElementById("btnFecharAdmin").addEventListener("click", fecharAdmin);

    document.getElementById("formInscricao").addEventListener("submit", handleSubmitInscricao);
    document.getElementById("btnAdicionarExcecao").addEventListener("click", handleAdicionarExcecao);
    document.getElementById("btnCancelarInscricao").addEventListener("click", handleCancelarInscricao);
    document.getElementById("adminSearch").addEventListener("input", filtrarTabelaAdminPorNome);
    document.getElementById("btnGerarRelatorio").addEventListener("click", gerarRelatorio);
    document.getElementById("btnImprimirRelatorio").addEventListener("click", imprimirRelatorio);

    // JOGOS - eventos
    if (btnVerJogos) {
        btnVerJogos.addEventListener("click", alternarPainelJogos);
    }
    if (filtroSerieJogo) {
        filtroSerieJogo.addEventListener("change", function() {
            renderizarJogos();
        });
    }
    if (filtroDataJogo) {
        filtroDataJogo.addEventListener("change", function() {
            renderizarJogos();
        });
    }
    if (jogoTurma1 && jogoTurma2) {
        jogoTurma1.innerHTML = '<option value="">Selecione o turno primeiro...</option>';
        jogoTurma2.innerHTML = '<option value="">Selecione o turno primeiro...</option>';
    }
    if (jogoTurno && jogoTurma1 && jogoTurma2) {
        jogoTurno.addEventListener("change", function() {
            const turno = this.value;
            const turmasTurno = getTurmasPorTurno(turno);
            jogoTurma1.innerHTML = "";
            jogoTurma2.innerHTML = "";

            const opt1 = document.createElement("option");
            opt1.value = "";
            opt1.textContent = turno ? "Selecione a turma 1..." : "Selecione o turno primeiro...";
            jogoTurma1.appendChild(opt1);

            const opt2 = document.createElement("option");
            opt2.value = "";
            opt2.textContent = turno ? "Selecione a turma 2..." : "Selecione o turno primeiro...";
            jogoTurma2.appendChild(opt2);

            if (turno) {
                turmasTurno.forEach(function(t) {
                    const o1 = document.createElement("option");
                    o1.value = t;
                    o1.textContent = t;
                    jogoTurma1.appendChild(o1);

                    const o2 = document.createElement("option");
                    o2.value = t;
                    o2.textContent = t;
                    jogoTurma2.appendChild(o2);
                });
            }
        });
    }
    if (btnCadastrarJogo) {
        btnCadastrarJogo.addEventListener("click", handleCadastrarJogo);
    }
    if (btnExcluirJogo) {
        btnExcluirJogo.addEventListener("click", handleExcluirJogo);
    }

    iniciarListenerInscricoes();
    iniciarListenerExcecoes();
    iniciarListenerJogos(); // JOGOS
}

if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initInterclasse);
} else {
    initInterclasse();
}

/* ============= 6) LISTENERS FIRESTORE ============= */

function iniciarListenerInscricoes() {
    db.collection("inscricoes")
        .orderBy("timestamp", "asc")
        .onSnapshot(function(snapshot) {
            todasInscricoes = [];
            countsPorTurmaModalidade = {};
            countsQueimadaGenero = {};

            snapshot.forEach(function(doc) {
                const data = doc.data();
                const nome = data.nome || "";
                const nomeNormalizado = data.nomeNormalizado || normalizarNome(nome);
                const sexo = data.sexo || "";
                const turma = data.turma;
                const modalidades = data.modalidades || [];

                const registro = {
                    id: doc.id,
                    nome: nome,
                    nomeNormalizado: nomeNormalizado,
                    email: data.email || "",
                    sexo: sexo,
                    turma: turma,
                    turno: data.turno,
                    camisaNumero: data.camisaNumero,
                    modalidades: modalidades,
                    observacoes: data.observacoes,
                    timestamp: data.timestamp
                };
                todasInscricoes.push(registro);

                if (!countsPorTurmaModalidade[turma]) {
                    countsPorTurmaModalidade[turma] = {};
                }
                modalidades.forEach(function(m) {
                    if (!countsPorTurmaModalidade[turma][m]) {
                        countsPorTurmaModalidade[turma][m] = 0;
                    }
                    countsPorTurmaModalidade[turma][m]++;

                    if (m === "QUEIMADA MISTA") {
                        if (!countsQueimadaGenero[turma]) {
                            countsQueimadaGenero[turma] = { Masculino: 0, Feminino: 0 };
                        }
                        if (sexo === "Masculino") {
                            countsQueimadaGenero[turma].Masculino++;
                        } else if (sexo === "Feminino") {
                            countsQueimadaGenero[turma].Feminino++;
                        }
                    }
                });
            });

            atualizarDisponibilidadeModalidades();
            renderizarTabelaPublica();
            renderizarTabelaAdmin();
            atualizarSelectCancelar();
        }, function(error) {
            console.error("Erro ao ouvir inscri√ß√µes:", error);
        });
}

function iniciarListenerExcecoes() {
    db.collection("nomesExcecao")
        .orderBy("nomeOriginal")
        .onSnapshot(function(snapshot) {
            nomesExcecao = [];
            snapshot.forEach(function(doc) {
                const data = doc.data();
                nomesExcecao.push({
                    id: doc.id,
                    nomeOriginal: data.nomeOriginal,
                    nomeNormalizado: data.nomeNormalizado
                });
            });
            renderizarListaExcecoes();
        }, function(error) {
            console.error("Erro ao ouvir exce√ß√µes:", error);
        });
}

/* JOGOS - listener Firestore */
function iniciarListenerJogos() {
    db.collection("jogos")
        .orderBy("dataJogo", "asc")
        .onSnapshot(function(snapshot) {
            todosJogos = [];
            snapshot.forEach(function(doc) {
                const data = doc.data();
                todosJogos.push({
                    id: doc.id,
                    turno: data.turno,
                    turma1: data.turma1,
                    turma2: data.turma2,
                    dataJogo: data.dataJogo,
                    horarioJogo: data.horarioJogo,
                    localJogo: data.localJogo
                });
            });
            atualizarSelectExcluirJogo();
            renderizarJogos();
        }, function(error) {
            console.error("Erro ao ouvir jogos:", error);
        });
}

/* ============= 7) FORMUL√ÅRIO DE INSCRI√á√ÉO ============= */

async function handleSubmitInscricao(event) {
    event.preventDefault();

    // Bloqueia novas inscri√ß√µes ap√≥s a data de expira√ß√£o
    if (inscricoesEncerradas) {
        mostrarMensagemForm("As inscri√ß√µes foram encerradas. Prazo final: 08/12/2025.", false);
        return;
    }

    if (!emailAtual || !validarEmail(emailAtual)) {
        alert("Informe seu e-mail antes de fazer a inscri√ß√£o.");
        return;
    }

    const nome = document.getElementById("nome").value.trim();
    const sexo = document.getElementById("sexo").value;
    const turma = document.getElementById("turma").value;
    const turno = document.getElementById("turno").value;
    const camisaNumero = document.getElementById("camisaNumero").value.trim();
    const observacoes = document.getElementById("observacoes").value.trim();
    const selecionados = [];
    const checks = document.querySelectorAll(".chkModalidade:checked");
    for (let i = 0; i < checks.length; i++) {
        selecionados.push(checks[i].value);
    }

    const partesNome = nome.split(/\s+/).filter(function(p) { return p; });
    const qtdPartes = partesNome.length;
    const nomeNormalizado = normalizarNome(nome);

    if (qtdPartes <= 2) {
        let autorizado = false;
        for (let i = 0; i < nomesExcecao.length; i++) {
            if (nomesExcecao[i].nomeNormalizado === nomeNormalizado) {
                autorizado = true;
                break;
            }
        }
        if (!autorizado) {
            mostrarMensagemForm(
                "Seu nome possui apenas 2 palavras. Procure a coordena√ß√£o para que seu nome seja autorizado na √°rea administrativa.",
                false
            );
            return;
        }
    }

    if (!nome || !sexo || !turma || !turno) {
        mostrarMensagemForm("Preencha nome, sexo, turno e turma.", false);
        return;
    }
    if (selecionados.length === 0) {
        mostrarMensagemForm("Escolha pelo menos 1 modalidade.", false);
        return;
    }
    if (selecionados.length > LIMITE_MODALIDADES_POR_ALUNO) {
        mostrarMensagemForm("Voc√™ s√≥ pode escolher at√© " + LIMITE_MODALIDADES_POR_ALUNO + " modalidades.", false);
        return;
    }

    for (let i = 0; i < selecionados.length; i++) {
        const mod = selecionados[i];
        if (mod === "QUEIMADA MISTA") {
            const totPorTurma = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) ? countsPorTurmaModalidade[turma][mod] : 0;
            const gen = countsQueimadaGenero[turma] || { Masculino: 0, Feminino: 0 };
            const qtdM = gen.Masculino || 0;
            const qtdF = gen.Feminino || 0;

            if (totPorTurma >= LIMITE_QUEIMADA_TOTAL) {
                mostrarMensagemForm(
                    'A QUEIMADA MISTA est√° LOTADA para a turma ' + turma + ' (10/10).',
                    false
                );
                return;
            }
            if (sexo === "Masculino" && qtdM >= LIMITE_QUEIMADA_POR_SEXO) {
                mostrarMensagemForm(
                    'J√° h√° 5 meninos na QUEIMADA MISTA da turma ' + turma + '. Escolha outra modalidade.',
                    false
                );
                return;
            }
            if (sexo === "Feminino" && qtdF >= LIMITE_QUEIMADA_POR_SEXO) {
                mostrarMensagemForm(
                    'J√° h√° 5 meninas na QUEIMADA MISTA da turma ' + turma + '. Escolha outra modalidade.',
                    false
                );
                return;
            }
        } else {
            const limite = LIMITE_MODALIDADE_TURMA[mod] || 8;
            const qtdAtual = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) ? countsPorTurmaModalidade[turma][mod] : 0;
            if (qtdAtual >= limite) {
                mostrarMensagemForm(
                    'A modalidade "' + mod + '" est√° LOTADA para a turma ' + turma + ' (' + qtdAtual + '/' + limite + '). Escolha outra modalidade.',
                    false
                );
                return;
            }
        }
    }

    for (let i = 0; i < todasInscricoes.length; i++) {
        const ins = todasInscricoes[i];
        if (ins.nomeNormalizado === nomeNormalizado && ins.turma === turma) {
            mostrarMensagemForm("J√° existe uma inscri√ß√£o para este nome nesta turma. Procure a coordena√ß√£o se precisar alterar.", false);
            return;
        }
    }

    try {
        await db.collection("inscricoes").add({
            nome: nome,
            nomeNormalizado: nomeNormalizado,
            email: emailAtual,
            sexo: sexo,
            turma: turma,
            turno: turno,
            camisaNumero: camisaNumero || null,
            modalidades: selecionados,
            observacoes: observacoes || null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        mostrarMensagemForm("Inscri√ß√£o realizada com sucesso! ‚úÖ", true);

        document.getElementById("formInscricao").reset();
        const selectTurma2 = document.getElementById("turma");
        selectTurma2.innerHTML = '<option value="">Selecione o turno primeiro...</option>';
        selectTurma2.disabled = true;
        atualizarDisponibilidadeModalidades();
    } catch (error) {
        console.error("Erro ao salvar inscri√ß√£o:", error);
        mostrarMensagemForm("Ocorreu um erro ao salvar sua inscri√ß√£o. Tente novamente.", false);
    }
}

/* ============= 8) DISPONIBILIDADE DAS MODALIDADES ============= */

function atualizarDisponibilidadeModalidades() {
    const turma = document.getElementById("turma").value;
    const sexo = document.getElementById("sexo").value;
    const spans = document.querySelectorAll(".modalidade-vagas");
    const checkboxes = document.querySelectorAll(".chkModalidade");

    for (let i = 0; i < spans.length; i++) {
        const span = spans[i];
        const mod = span.dataset.mod;
        if (!turma) {
            span.textContent = mod + " (selecione turno e turma primeiro)";
            span.classList.remove("modalidade-lotado");
        } else {
            if (mod === "QUEIMADA MISTA") {
                const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) ? countsPorTurmaModalidade[turma][mod] : 0;
                const gen = countsQueimadaGenero[turma] || { Masculino: 0, Feminino: 0 };
                const qtdM = gen.Masculino || 0;
                const qtdF = gen.Feminino || 0;
                span.textContent = mod + " (" + tot + "/10 - Meninas: " + qtdF + "/5, Meninos: " + qtdM + "/5)";
                if (tot >= LIMITE_QUEIMADA_TOTAL) {
                    span.classList.add("modalidade-lotado");
                } else {
                    span.classList.remove("modalidade-lotado");
                }
            } else {
                const limite = LIMITE_MODALIDADE_TURMA[mod] || 8;
                const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) ? countsPorTurmaModalidade[turma][mod] : 0;
                if (qtd >= limite) {
                    span.textContent = mod + " (LOTADO - " + qtd + "/" + limite + ")";
                    span.classList.add("modalidade-lotado");
                } else {
                    span.textContent = mod + " (" + qtd + "/" + limite + " vagas ocupadas)";
                    span.classList.remove("modalidade-lotado");
                }
            }
        }
    }

    for (let i = 0; i < checkboxes.length; i++) {
        const chk = checkboxes[i];
        const mod = chk.value;
        if (!turma) {
            chk.disabled = true;
            chk.checked = false;
            continue;
        }
        if (mod === "QUEIMADA MISTA") {
            const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) ? countsPorTurmaModalidade[turma][mod] : 0;
            const gen = countsQueimadaGenero[turma] || { Masculino: 0, Feminino: 0 };
            const qtdM = gen.Masculino || 0;
            const qtdF = gen.Feminino || 0;

            if (!sexo) {
                chk.disabled = true;
                chk.checked = false;
            } else if (tot >= LIMITE_QUEIMADA_TOTAL) {
                chk.disabled = true;
                chk.checked = false;
            } else if (sexo === "Masculino" && qtdM >= LIMITE_QUEIMADA_POR_SEXO) {
                chk.disabled = true;
                chk.checked = false;
            } else if (sexo === "Feminino" && qtdF >= LIMITE_QUEIMADA_POR_SEXO) {
                chk.disabled = true;
                chk.checked = false;
            } else {
                chk.disabled = false;
            }
        } else {
            const limite = LIMITE_MODALIDADE_TURMA[mod] || 8;
            const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) ? countsPorTurmaModalidade[turma][mod] : 0;
            if (qtd >= limite) {
                chk.disabled = true;
                chk.checked = false;
            } else {
                chk.disabled = false;
            }
        }
    }
}

/* ============= 9) TABELA P√öBLICA ============= */

function renderizarTabelaPublica() {
    const corpo = document.querySelector("#tabelaPublica tbody");
    if (!corpo) return;
    corpo.innerHTML = "";

    const filtroMod = document.getElementById("filtroModalidade").value;
    const filtroTurma = document.getElementById("filtroTurma").value;

    const listaFiltrada = [];
    for (let i = 0; i < todasInscricoes.length; i++) {
        const ins = todasInscricoes[i];
        let ok = true;
        if (filtroTurma !== "TODAS" && ins.turma !== filtroTurma) ok = false;
        if (filtroMod !== "TODAS" && ins.modalidades && ins.modalidades.indexOf(filtroMod) === -1) ok = false;
        if (ok) listaFiltrada.push(ins);
    }

    if (listaFiltrada.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 2;
        td.textContent = "Nenhum inscrito encontrado com esses filtros.";
        tr.appendChild(td);
        corpo.appendChild(tr);
        return;
    }

    for (let i = 0; i < listaFiltrada.length; i++) {
        const ins = listaFiltrada[i];
        const tr = document.createElement("tr");
        const tdNome = document.createElement("td");
        const tdTurma = document.createElement("td");

        tdNome.textContent = ins.nome;
        tdTurma.textContent = ins.turma;

        tr.appendChild(tdNome);
        tr.appendChild(tdTurma);
        corpo.appendChild(tr);
    }
}

/* ============= 10) TABELA ADMIN ============= */

function renderizarTabelaAdmin() {
    if (!isAdmin) return;
    const corpo = document.querySelector("#tabelaAdmin tbody");
    if (!corpo) return;
    corpo.innerHTML = "";

    if (todasInscricoes.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.textContent = "Ainda n√£o h√° inscri√ß√µes.";
        tr.appendChild(td);
        corpo.appendChild(tr);
        return;
    }

    for (let i = 0; i < todasInscricoes.length; i++) {
        const ins = todasInscricoes[i];
        const tr = document.createElement("tr");

        const tdNome = document.createElement("td");
        const tdEmail = document.createElement("td");
        const tdSexo = document.createElement("td");
        const tdTurma = document.createElement("td");
        const tdTurno = document.createElement("td");
        const tdCamisa = document.createElement("td");
        const tdMods = document.createElement("td");
        const tdObs = document.createElement("td");
        const tdData = document.createElement("td");

        tdNome.textContent = ins.nome || "";
        tdEmail.textContent = ins.email || "";
        tdSexo.textContent = ins.sexo || "";
        tdTurma.textContent = ins.turma || "";
        tdTurno.textContent = ins.turno || "";
        tdCamisa.textContent = ins.camisaNumero || "";
        tdMods.textContent = (ins.modalidades || []).join(", ");
        tdObs.textContent = ins.observacoes || "";

        if (ins.timestamp && ins.timestamp.toDate) {
            const d = ins.timestamp.toDate();
            const dataStr = d.toLocaleDateString("pt-BR");
            const horaStr = d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
            tdData.textContent = dataStr + " " + horaStr;
        } else {
            tdData.textContent = "-";
        }

        tr.appendChild(tdNome);
        tr.appendChild(tdEmail);
        tr.appendChild(tdSexo);
        tr.appendChild(tdTurma);
        tr.appendChild(tdTurno);
        tr.appendChild(tdCamisa);
        tr.appendChild(tdMods);
        tr.appendChild(tdObs);
        tr.appendChild(tdData);
        corpo.appendChild(tr);
    }
}

/* ============= 11) BUSCA ADMIN ============= */

function filtrarTabelaAdminPorNome() {
    const termo = (document.getElementById("adminSearch").value || "").toLowerCase().trim();
    const linhas = document.querySelectorAll("#tabelaAdmin tbody tr");
    if (!linhas.length) return;

    linhas.forEach(function(tr) {
        const tdNome = tr.children[0];
        if (!tdNome) return;
        const nome = (tdNome.textContent || "").toLowerCase();
        if (!termo || nome.includes(termo)) {
            tr.style.display = "";
        } else {
            tr.style.display = "none";
        }
    });
}

/* ============= 12) EXCE√á√ïES DE NOME ============= */

async function handleAdicionarExcecao() {
    const input = document.getElementById("nomeExcecao");
    const nomeOriginal = (input.value || "").trim();
    if (!nomeOriginal) {
        alert("Digite um nome para autorizar.");
        return;
    }
    const nomeNorm = normalizarNome(nomeOriginal);
    if (!nomeNorm) {
        alert("Nome inv√°lido.");
        return;
    }

    for (let i = 0; i < nomesExcecao.length; i++) {
        if (nomesExcecao[i].nomeNormalizado === nomeNorm) {
            alert("Esse nome j√° est√° autorizado como exce√ß√£o.");
            return;
        }
    }

    try {
        await db.collection("nomesExcecao").add({
            nomeOriginal: nomeOriginal,
            nomeNormalizado: nomeNorm
        });
        input.value = "";
        alert("Nome autorizado com sucesso.");
    } catch (error) {
        console.error("Erro ao salvar exce√ß√£o de nome:", error);
        alert("Erro ao salvar exce√ß√£o. Tente novamente.");
    }
}

function renderizarListaExcecoes() {
    const ul = document.getElementById("listaExcecoes");
    if (!ul) return;
    ul.innerHTML = "";
    if (nomesExcecao.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Nenhum nome com 2 palavras autorizado ainda.";
        ul.appendChild(li);
        return;
    }
    for (let i = 0; i < nomesExcecao.length; i++) {
        const e = nomesExcecao[i];
        const li = document.createElement("li");
        li.textContent = e.nomeOriginal;
        ul.appendChild(li);
    }
}

/* ============= 13) CANCELAR INSCRI√á√ÉO ============= */

function atualizarSelectCancelar() {
    const sel = document.getElementById("selectCancelar");
    if (!sel) return;
    const valorAnterior = sel.value;
    sel.innerHTML = "";
    const optPadrao = document.createElement("option");
    optPadrao.value = "";
    optPadrao.textContent = "Selecione um inscrito...";
    sel.appendChild(optPadrao);

    for (let i = 0; i < todasInscricoes.length; i++) {
        const ins = todasInscricoes[i];
        const opt = document.createElement("option");
        const mods = (ins.modalidades || []).join(", ");
        opt.value = ins.id;
        opt.textContent = ins.nome + " ‚Äî " + ins.turma + (mods ? " ‚Äî " + mods : "");
        sel.appendChild(opt);
    }

    if (valorAnterior) {
        sel.value = valorAnterior;
    }
}

async function handleCancelarInscricao() {
    if (!isAdmin) {
        alert("Apenas a coordena√ß√£o (√°rea administrativa) pode cancelar inscri√ß√µes.");
        return;
    }
    const sel = document.getElementById("selectCancelar");
    const id = sel.value;
    if (!id) {
        alert("Selecione um inscrito para cancelar.");
        return;
    }
    let inscrito = null;
    for (let i = 0; i < todasInscricoes.length; i++) {
        if (todasInscricoes[i].id === id) {
            inscrito = todasInscricoes[i];
            break;
        }
    }
    if (!inscrito) {
        alert("Inscri√ß√£o n√£o encontrada. Atualize a p√°gina.");
        return;
    }
    const confirmacao = confirm('Tem certeza que deseja cancelar a inscri√ß√£o de "' + inscrito.nome + '" da turma ' + inscrito.turma + '?');
    if (!confirmacao) return;

    try {
        await db.collection("inscricoes").doc(id).delete();
        alert("Inscri√ß√£o cancelada com sucesso. As vagas foram liberadas.");
    } catch (error) {
        console.error("Erro ao cancelar inscri√ß√£o:", error);
        alert("Erro ao cancelar inscri√ß√£o. Tente novamente.");
    }
}

/* ============= 14) RELAT√ìRIO POR MODALIDADE / TURMA (BOT√ÉO) ============= */

function gerarRelatorio() {
    if (!isAdmin) {
        alert("Apenas a √°rea administrativa pode gerar relat√≥rios.");
        return;
    }
    const turmaSel = document.getElementById("relTurma").value;
    const modSel = document.getElementById("relModalidade").value;
    const corpo = document.querySelector("#tabelaRelatorio tbody");
    if (!corpo) return;
    corpo.innerHTML = "";

    if (!turmaSel || !modSel) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.textContent = "Selecione a turma e a modalidade para gerar o relat√≥rio.";
        tr.appendChild(td);
        corpo.appendChild(tr);
        return;
    }

    const listaFiltrada = [];
    for (let i = 0; i < todasInscricoes.length; i++) {
        const ins = todasInscricoes[i];
        if (ins.turma === turmaSel && ins.modalidades && ins.modalidades.indexOf(modSel) !== -1) {
            listaFiltrada.push(ins);
        }
    }

    if (listaFiltrada.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.textContent = "N√£o h√° inscritos para essa turma e modalidade.";
        tr.appendChild(td);
        corpo.appendChild(tr);
        return;
    }

    for (let i = 0; i < listaFiltrada.length; i++) {
        const ins = listaFiltrada[i];
        const tr = document.createElement("tr");

        const tdNome = document.createElement("td");
        const tdEmail = document.createElement("td");
        const tdSexo = document.createElement("td");
        const tdTurma = document.createElement("td");
        const tdTurno = document.createElement("td");
        const tdCamisa = document.createElement("td");
        const tdMods = document.createElement("td");
        const tdObs = document.createElement("td");
        const tdData = document.createElement("td");

        tdNome.textContent = ins.nome || "";
        tdEmail.textContent = ins.email || "";
        tdSexo.textContent = ins.sexo || "";
        tdTurma.textContent = ins.turma || "";
        tdTurno.textContent = ins.turno || "";
        tdCamisa.textContent = ins.camisaNumero || "";
        tdMods.textContent = (ins.modalidades || []).join(", ");
        tdObs.textContent = ins.observacoes || "";

        if (ins.timestamp && ins.timestamp.toDate) {
            const d = ins.timestamp.toDate();
            const dataStr = d.toLocaleDateString("pt-BR");
            const horaStr = d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
            tdData.textContent = dataStr + " " + horaStr;
        } else {
            tdData.textContent = "-";
        }

        tr.appendChild(tdNome);
        tr.appendChild(tdEmail);
        tr.appendChild(tdSexo);
        tr.appendChild(tdTurma);
        tr.appendChild(tdTurno);
        tr.appendChild(tdCamisa);
        tr.appendChild(tdMods);
        tr.appendChild(tdObs);
        tr.appendChild(tdData);
        corpo.appendChild(tr);
    }
}

function imprimirRelatorio() {
    if (!isAdmin) {
        alert("Apenas a √°rea administrativa pode imprimir relat√≥rios.");
        return;
    }
    window.print();
}

/* ============= 15) TROCA DE TELAS (ALUNO / INSCRITOS / ADMIN / JOGOS) ============= */

function alternarPainelInscritos() {
    if (adminAberto) {
        fecharAdmin();
    }
    const secForm = document.getElementById("secInscricao");
    const secInscritos = document.getElementById("secInscritos");
    const admin = document.getElementById("adminSection");
    const btn = document.getElementById("btnToggleInscritos");
    const secJogos = document.getElementById("secJogos");
    const btnJogos = document.getElementById("btnVerJogos");

    admin.style.display = "none";
    if (secJogos) secJogos.style.display = "none";
    mostrandoJogos = false;
    if (btnJogos) btnJogos.textContent = "üèÜ Ver jogos";

    mostrandoInscritos = !mostrandoInscritos;
    if (mostrandoInscritos) {
        secForm.style.display = "none";
        secInscritos.style.display = "block";
        btn.textContent = "‚¨Ö Voltar para inscri√ß√£o";
        secInscritos.scrollIntoView({ behavior: "smooth" });
    } else {
        secForm.style.display = "block";
        secInscritos.style.display = "none";
        btn.textContent = "üëÄ Ver inscritos";
        secForm.scrollIntoView({ behavior: "smooth" });
    }
}

/* JOGOS - alternar painel de jogos */
function alternarPainelJogos() {
    if (adminAberto) {
        fecharAdmin();
    }
    const secForm = document.getElementById("secInscricao");
    const secInscritos = document.getElementById("secInscritos");
    const secJogos = document.getElementById("secJogos");
    const btnJogos = document.getElementById("btnVerJogos");
    const btnInscritos = document.getElementById("btnToggleInscritos");

    if (!secJogos || !btnJogos) return;

    // Garantir que o painel de inscritos esteja fechado
    mostrandoInscritos = false;
    if (secInscritos) secInscritos.style.display = "none";
    if (btnInscritos) btnInscritos.textContent = "üëÄ Ver inscritos";

    mostrandoJogos = !mostrandoJogos;
    if (mostrandoJogos) {
        secForm.style.display = "none";
        secJogos.style.display = "block";
        btnJogos.textContent = "‚¨Ö Voltar para inscri√ß√£o";
        secJogos.scrollIntoView({ behavior: "smooth" });
    } else {
        secForm.style.display = "block";
        secJogos.style.display = "none";
        btnJogos.textContent = "üèÜ Ver jogos";
        secForm.scrollIntoView({ behavior: "smooth" });
    }
}

function abrirAdmin() {
    const secForm = document.getElementById("secInscricao");
    const secInscritos = document.getElementById("secInscritos");
    const admin = document.getElementById("adminSection");
    const secJogos = document.getElementById("secJogos");
    const btnJogos = document.getElementById("btnVerJogos");
    const btnInscritos = document.getElementById("btnToggleInscritos");

    adminAberto = true;
    if (btnJogos) btnJogos.textContent = "üèÜ Ver jogos";
    mostrandoJogos = false;
    if (secJogos) secJogos.style.display = "none";

    mostrandoInscritos = false;
    if (btnInscritos) btnInscritos.textContent = "üëÄ Ver inscritos";

    secForm.style.display = "none";
    if (secInscritos) secInscritos.style.display = "none";
    admin.style.display = "block";
    renderizarTabelaAdmin();
    admin.scrollIntoView({ behavior: "smooth" });
}

function fecharAdmin() {
    const secForm = document.getElementById("secInscricao");
    const secInscritos = document.getElementById("secInscritos");
    const admin = document.getElementById("adminSection");

    adminAberto = false;
    isAdmin = false;
    admin.style.display = "none";

    if (mostrandoInscritos) {
        secInscritos.style.display = "block";
        secForm.style.display = "none";
    } else {
        secForm.style.display = "block";
        secInscritos.style.display = "none";
    }
}

/* ============= 16) JOGOS - RENDERIZA√á√ÉO, CADASTRO E EXCLUS√ÉO ============= */

function renderizarJogos() {
    const container = document.getElementById("listaJogosContainer");
    if (!container) return;
    container.innerHTML = "";

    const filtroSerieEl = document.getElementById("filtroSerieJogo");
    const filtroDataEl = document.getElementById("filtroDataJogo");
    const serieFiltro = filtroSerieEl ? filtroSerieEl.value : "";
    const dataFiltro = filtroDataEl ? filtroDataEl.value : "";

    if (!serieFiltro) {
        container.textContent = "Selecione uma s√©rie para ver os jogos.";
        return;
    }

    let filtrados = todosJogos.filter(function(j) {
        const s1 = getSerieDigitFromTurma(j.turma1);
        const s2 = getSerieDigitFromTurma(j.turma2);
        if (s1 !== serieFiltro && s2 !== serieFiltro) return false;

        if (dataFiltro && j.dataJogo !== dataFiltro) {
            return false;
        }

        return true;
    });

    if (filtrados.length === 0) {
        container.textContent = "N√£o h√° jogos para os filtros selecionados.";
        return;
    }

    filtrados.forEach(function(jogo) {
        const wrap = document.createElement("div");
        wrap.className = "jogo-tabela-wrapper";

        const tabela = document.createElement("table");
        const tbody = document.createElement("tbody");

        function addLinha(label, valor) {
            const tr = document.createElement("tr");
            const th = document.createElement("th");
            const td = document.createElement("td");
            th.textContent = label;
            td.textContent = valor || "-";
            tr.appendChild(th);
            tr.appendChild(td);
            tbody.appendChild(tr);
        }

        addLinha("Data", formatarDataBR(jogo.dataJogo));
        addLinha("Hor√°rio", jogo.horarioJogo || "-");
        addLinha("Jogo", (jogo.turma1 || "") + " vs " + (jogo.turma2 || ""));
        addLinha("Local", jogo.localJogo || "-");

        tabela.appendChild(tbody);
        wrap.appendChild(tabela);
        container.appendChild(wrap);
    });
}

async function handleCadastrarJogo(event) {
    if (event && event.preventDefault) {
        event.preventDefault();
    }

    if (!isAdmin) {
        alert("Apenas a √°rea administrativa pode cadastrar jogos.");
        return;
    }

    const turno = document.getElementById("jogoTurno").value;
    const turma1 = document.getElementById("jogoTurma1").value;
    const turma2 = document.getElementById("jogoTurma2").value;
    const dataJogo = document.getElementById("jogoData").value;
    const horarioJogo = document.getElementById("jogoHorario").value;
    const localJogo = (document.getElementById("jogoLocal").value || "").trim();

    if (!turno || !turma1 || !turma2 || !dataJogo || !horarioJogo || !localJogo) {
        alert("Preencha todos os campos do jogo.");
        return;
    }

    if (turma1 === turma2) {
        alert("Turma 1 e Turma 2 devem ser diferentes.");
        return;
    }

    try {
        await db.collection("jogos").add({
            turno: turno,
            turma1: turma1,
            turma2: turma2,
            dataJogo: dataJogo,
            horarioJogo: horarioJogo,
            localJogo: localJogo,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Jogo cadastrado com sucesso.");

        document.getElementById("jogoTurma1").value = "";
        document.getElementById("jogoTurma2").value = "";
        document.getElementById("jogoData").value = "";
        document.getElementById("jogoHorario").value = "";
        document.getElementById("jogoLocal").value = "";
    } catch (error) {
        console.error("Erro ao cadastrar jogo:", error);
        alert("Erro ao cadastrar jogo. Tente novamente.");
    }
}

function atualizarSelectExcluirJogo() {
    const sel = document.getElementById("selectExcluirJogo");
    if (!sel) return;
    const valorAnterior = sel.value;
    sel.innerHTML = "";
    const optPadrao = document.createElement("option");
    optPadrao.value = "";
    optPadrao.textContent = "Selecione um jogo...";
    sel.appendChild(optPadrao);

    todosJogos.forEach(function(jogo) {
        const opt = document.createElement("option");
        opt.value = jogo.id;
        const dataLabel = formatarDataBR(jogo.dataJogo);
        const label =
            (jogo.turno || "") +
            " - " +
            dataLabel +
            " " +
            (jogo.horarioJogo || "") +
            " - " +
            (jogo.turma1 || "") +
            " vs " +
            (jogo.turma2 || "");
        opt.textContent = label.trim();
        sel.appendChild(opt);
    });

    if (valorAnterior) {
        sel.value = valorAnterior;
    }
}

async function handleExcluirJogo() {
    if (!isAdmin) {
        alert("Apenas a √°rea administrativa pode excluir jogos.");
        return;
    }
    const sel = document.getElementById("selectExcluirJogo");
    if (!sel) return;
    const id = sel.value;
    if (!id) {
        alert("Selecione um jogo para excluir.");
        return;
    }

    const jogo = todosJogos.find(function(j) { return j.id === id; });
    const descricao = jogo
        ? ((jogo.turma1 || "") + " vs " + (jogo.turma2 || "") + " - " + formatarDataBR(jogo.dataJogo) + " " + (jogo.horarioJogo || ""))
        : "";

    const conf = confirm("Tem certeza que deseja excluir este jogo?\n" + descricao);
    if (!conf) return;

    try {
        await db.collection("jogos").doc(id).delete();
        alert("Jogo exclu√≠do com sucesso.");
    } catch (error) {
        console.error("Erro ao excluir jogo:", error);
        alert("Erro ao excluir jogo. Tente novamente.");
    }
}
</script>
</body>
</html>
